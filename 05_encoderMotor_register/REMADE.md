# STM32F103C8T6 直流减速电机速度闭环控制

## 一、项目概述

基于 STM32F103C8T6 微控制器，实现 JGA25-370 直流减速电机的速度闭环控制，通过电机内置的 AB 双相增量式磁性霍尔编码器反馈转速，结合 PID 算法调节 PWM 输出，实现稳定的速度控制。

**核心功能：**

- 使用 STM32 的 TIM4 编码器模式，高精度读取电机霍尔编码器转速。
- 通过 TIM3 定时中断（50ms），周期性采样编码器计数并计算转速（RPM）。
- 基于 PID 算法，实时调整 TIM2 PWM 输出，控制电机速度。
- 通过 USART1 串口（CH340 模块）输出目标转速、实际转速和 PWM 值，便于调试。

**注意**：本项目针对 JGA25-370-21.3K 280 RPM 电机，编码器每圈产生约 937 计数（四倍频，11 PPR * 21.3 减速比 * 4）。如使用不同电机或编码器，需调整 `PULSES_PER_REV` 参数。

## 二、硬件平台

- **主控芯片**：STM32F103C8T6（72MHz 主频）
- **电机**：JGA25-370-21.3K 直流减速电机（额定 280 RPM，带 AB 双相增量式磁性霍尔编码器，基础脉冲 11 PPR，减速比 21.3:1，四倍频后约 937 计数/圈）
- **编码器**：内置于 JGA25-370 的霍尔编码器，支持 3.3V/5V 供电，带上拉整形电阻，PH2.0 接口，AB 相方波输出，响应频率 100kHz，22 极磁环（11 对极）
- **电机驱动**：TB6612FNG 电机驱动模块
- **串口模块**：CH340（USB 转 TTL，用于调试输出）
- **烧录工具**：ST-Link V2

## 三、开发环境

- **主开发 IDE**：Keil MDK
- **辅助编辑器**：VSCode
- **开发语言**：C 语言（基于寄存器直接操作）
- **调试工具**：ST-Link V2，串口调试助手（波特率 115200）

## 四、硬件接线说明

| 外设模块             | 引脚连接 (STM32F103C8T6)                                     | 接线细节                                                     |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **JGA25-370 编码器** | C1（A相）→ PB6 C2（B相）→ PB7 VCC → 3.3V GND → GND           | 编码器 A、B相连接到 PB6 和 PB7，VCC 和 GND 连接到 STM32 的 3.3V 和 GND（支持 3.3V/5V，推荐 3.3V）。使用 PH2.0 接口和标配连接线。 |
| **JGA25-370 电机**   | M1, M2 → TB6612 AO1, AO2                                     | 电机电源 M1、M2 连接 TB6612 输出端，电压与电机匹配（6V 或 12V）。 |
| **TB6612 电机驱动**  | AIN1 → PB1 AIN2 → PB0 PWMA → PA3 VM → 6V/12V VCC → 5V GND → GND | PB1 和 PB0 控制电机方向，PA3 输出 PWM 信号，TB6612 VM 连接电机电源（6V/12V），VCC 连接 5V，GND 共地。 |
| **CH340 串口模块**   | TX → PA10 RX → PA9 VCC → 3.3V GND → GND                      | PA9 为串口 TX，PA10 为 RX，连接 CH340 的 RX 和 TX，波特率 115200。 |
| **ST-Link V2**       | SWDIO, SWCLK, GND, 3.3V                                      | 严格对应引脚连接，为单片机提供调试和烧录接口。               |

**特别注意：**

- 所有外设的 GND 必须与 STM32 的 GND 连接（共地）。
- JGA25-370 电机电源（M1、M2 通过 TB6612）需与电机额定电压匹配（6V 或 12V，推荐确认）。
- 编码器支持 3.3V/5V 供电，推荐使用 3.3V 与 STM32 一致，避免电平不匹配。
- 确保 TB6612 的 VM 电源与电机电压一致，VCC 使用 5V 供电。

## 五、工程结构

```plaintext
├── Hardware/
│   ├── encoder.c       # 编码器驱动（TIM4 编码器模式）
│   ├── JGA25_370.c     # JGA25-370 电机驱动（TB6612 控制）
│   ├── tim2.c          # TIM2 PWM 配置（PA3 输出）
│   ├── tim3.c          # TIM3 定时中断（50ms 采样）
│   └── usart.c         # USART1 串口配置（调试输出）
├── Interface/
│   └── pid.c           # PID 控制器实现
└── User/
    ├── includes.h      # 工程全局头文件统一管理
    └── main.c          # 主函数，实现 PID 闭环控制逻辑
```

## 六、功能实现说明

### 1. 核心工作原理

- **编码器模式**：
  - 使用 TIM4 的编码器模式 3（四倍频），通过 PB6（C1，A 相）和 PB7（C2，B 相）采样霍尔编码器信号。
  - 编码器基础脉冲 11 PPR，减速比 21.3:1，四倍频后每圈约 937 计数（`PULSES_PER_REV = 937`）。
  - `ENCODER_GetCount` 处理 TIM4 计数器溢出（±32768 阈值），计算累计脉冲数（`total_cnt`）。
- **转速采样**：
  - TIM3 配置为 50ms 定时中断（72MHz / 7200 / 500 = 20Hz）。
  - 在 `TIM3_IRQHandler` 中调用 `ENCODER_GetSpeed_rpm`，计算实际转速（`rpm_global`）并更新累计计数（`count_global`）。
  - 转速公式：`rpm = (delta / 0.05) / 937 * 60`，其中 `delta` 为 50ms 内计数变化。
- **PID 控制**：
  - 在 `main.c` 中，初始化 PID 控制器（Kp=2.1, Ki=0.8, Kd=0）。
  - 每 200ms 调用 `PID_Calc`，根据目标转速（`pid.SetSpeed`）和实际转速（`rpm_global`）计算 PWM 输出。
  - 输出范围限制为 -1000 到 1000，对应 PWM 占空比 0 到 1000。
- **电机驱动**：
  - TIM2 配置为 1kHz PWM（PA3，周期 1ms，`ARR = 999`），通过 `TIM2_SetCompare` 设置占空比。
  - TB6612 的 AIN1（PB1）和 AIN2（PB0）控制电机方向，PWMA（PA3）控制速度。
  - `JGA25_370_SetSpeed` 将 PID 输出映射到 PWM 值（线性映射：`pwm_val = |speed| * 1000 / 937`），并设置方向（正转：PB1 高，PB0 低；反转：PB1 低，PB0 高）。
- **调试输出**：
  - USART1（PA9 TX，PA10 RX，波特率 115200）通过 `printf` 输出目标转速、实际转速和 PWM 值，格式为 `Target,RPM,PWM`。

### 2. 关键参数

- **编码器分辨率**：基础脉冲 11 PPR，减速比 21.3:1，四倍频后约 937 计数/圈（`PULSES_PER_REV = 937`，计算：11 * 21.3 * 4 ≈ 936.4）。
- **采样周期**：TIM3 每 50ms 采样一次（`DELTA_T = 0.05`）。
- **PWM 频率**：TIM2 配置为 1kHz（周期 1ms，`ARR = 999`）。
- **PID 参数**：Kp=2.1, Ki=0.8, Kd=0，目标转速默认为 140 RPM。
- **编码器特性**：AB 相方波输出，响应频率 100kHz，22 极磁环，适合高速采样。

## 七、烧录与调试步骤

1. **硬件连接**：
   - 按照“硬件接线说明”连接 STM32、TB6612、JGA25-370 电机（含编码器）和 CH340 模块。
   - 确保电机电源（TB6612 VM，M1/M2）与 JGA25-370 的额定电压匹配（6V 或 12V）。
   - 使用 PH2.0 接口连接编码器，确认 VCC 使用 3.3V。
2. **驱动安装**：
   - 在 PC 端安装 ST-Link V2 驱动和 CH340 驱动。
   - 使用串口调试助手（如 SecureCRT 或 PuTTY）配置波特率 115200。
3. **工程配置**：
   - 在 Keil MDK 中创建新工程，选择 STM32F103C8T6 芯片。
   - 配置 ST-Link 调试器，启用 SWD 模式。
4. **程序烧录**：
   - 编译工程，检查无错误后通过 ST-Link 下载到 STM32。
5. **调试验证**：
   - 打开串口调试助手，观察目标转速、实际转速和 PWM 输出（格式：`140.00,140.85,540.83`）。
   - 调整 `pid.SetSpeed`（默认 140 RPM），验证电机是否稳定运行在目标转速。
   - 检查编码器计数（`count_global`）和转速（`rpm_global`）是否准确。

## 八、使用说明

1. 系统上电后，初始化编码器（TIM4）、定时器（TIM3）、PWM（TIM2）、PID 控制器和串口（USART1）。
2. 电机默认以 500 RPM 目标转速运行（可通过修改 `pid.SetSpeed` 调整）。
3. 通过串口调试助手查看输出，格式为 `Target,RPM,PWM`（例如 `140.00,140.85,540.83`）。
4. **正转**：编码器计数增加，转速为正，PWM 输出正值。
5. **反转**：若设置负目标转速，编码器计数减少，电机反向旋转。
6. **停止/刹车**：可调用 `JGA25_370_Stop` 或 `JGA25_370_Brake` 停止电机。

## 九、版本说明

- **当前版本**：V1.0
- **版本更新**：基础版，实现直流减速电机速度闭环控制，支持编码器转速反馈、PID 调节和串口调试。
- **版本状态**：核心功能已实现（编码器采样、PID 控制、PWM 输出、串口调试），代码模块化，结构清晰。

## 十、常见问题与解决

| **问题**                 | **可能原因**                          | **解决方案**                                                 |
| ------------------------ | ------------------------------------- | ------------------------------------------------------------ |
| 电机不转或转速不稳定     | PID 参数不合适、编码器接线错误        | 调整 `Kp`、`Ki`、`Kd`，检查 PB6/PB7 接线，确认 PH2.0 接口连接正确 |
| 串口无输出               | CH340 驱动未安装、波特率错误          | 安装 CH340 驱动，确认波特率 115200                           |
| 编码器计数异常（如跳变） | 霍尔编码器信号干扰、TIM4 溢出处理不足 | 添加信号滤波电容，验证 `ENCODER_GetCount` 溢出逻辑（±32768 阈值） |
| PWM 输出异常             | TIM2 配置错误、TB6612 电源不足        | 检查 `TIM2_SetCompare` 和 PA3 输出，确保 TB6612 VM 电压与电机匹配（6V/12V） |